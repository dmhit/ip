(function () {
    // Плейсхолдер токена, заменяется загрузчиком
    const TOKEN = '{TOKEN}';

    // Проверка страницы
    if (!window.location.pathname.startsWith('/pl/metrika/user/')) {
        console.log('Не на целевой странице.');
        return;
    }

    console.log('Geo+Blacklist Enhancer запущен');

    // Вспомогательные функции
    function isValidIP(ip) {
        const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        return ipRegex.test(ip);
    }

    function extractIP(text) {
        return text.replace(/\s*\n.*$/, '').trim();
    }

    // Кэширование
    const geoCachePrefix = 'geo_ip_';
    const blackCachePrefix = 'black_ip_';

    function getCachedGeo(ip) { const c = sessionStorage.getItem(geoCachePrefix + ip); return c ? JSON.parse(c) : null; }
    function setCachedGeo(ip, data) { sessionStorage.setItem(geoCachePrefix + ip, JSON.stringify(data)); }
    function getCachedBlack(ip) { const c = sessionStorage.getItem(blackCachePrefix + ip); return c ? JSON.parse(c) : null; }
    function setCachedBlack(ip, data) { sessionStorage.setItem(blackCachePrefix + ip, JSON.stringify(data)); }

    // Очереди запросов
    const geoQueue = [], blackQueue = [];
    let geoProcessing = false, blackProcessing = false;
    const DELAY = 1000;
    const RETRY_DELAY = 1500;
    const MAX_RETRIES = 7;

    function processQueue(queue, flagName, type) {
        if (window[flagName] || queue.length === 0) return;
        window[flagName] = true;
        const { url, resolve, reject, retries, startTime } = queue.shift();

        fetch(url)
            .then(async r => {
                if (r.status === 429 && retries > 0) {
                    console.log(`429 → повтор через ${RETRY_DELAY}мс`);
                    setTimeout(() => {
                        queue.unshift({ url, resolve, reject, retries: retries - 1, startTime });
                        processQueue(queue, flagName, type);
                    }, RETRY_DELAY);
                    window[flagName] = false;
                    return;
                }
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return type === 'geo' ? r.json() : r.text();
            })
            .then(resolve)
            .catch(reject)
            .finally(() => {
                setTimeout(() => {
                    window[flagName] = false;
                    processQueue(queue, flagName, type);
                }, DELAY);
            });
    }

    function queueGeo(url) {
        return new Promise((res, rej) => {
            geoQueue.push({ url, resolve: res, reject: rej, retries: MAX_RETRIES, startTime: Date.now() });
            processQueue(geoQueue, 'geoProcessing', 'geo');
        });
    }

    function queueBlack(url) {
        return new Promise((res, rej) => {
            blackQueue.push({ url, resolve: res, reject: rej, retries: MAX_RETRIES, startTime: Date.now() });
            processQueue(blackQueue, 'blackProcessing', 'black');
        });
    }

    // API
    async function fetchGeo(ip) {
        const cached = getCachedGeo(ip);
        if (cached) return cached;

        const data = await queueGeo(`https://api.2ip.io/${ip}?token=${TOKEN}&lang=ru`);
        const result = {
            country: `${data.country || 'N/A'} (${data.code || ''} ${data.emoji || ''})`.trim(),
            city: `${data.city || 'N/A'} (${data.region || ''})`.trim(),
            provider: 'N/A'
        };
        setCachedGeo(ip, result);
        return result;
    }

    async function fetchWhois(ip) {
        try {
            const data = await queueGeo(`https://api.2ip.io/whois/${ip}?token=${TOKEN}`);
            return data.whois?.network?.name || 'N/A';
        } catch (e) {
            console.error('Ошибка whois:', e);
            return 'N/A';
        }
    }

    async function fetchBlacklist(ip) {
        const cached = getCachedBlack(ip);
        if (cached) return cached;

        const text = await queueBlack(`${location.origin}/pl/gc/tools/check-blacklist-qrator?ip=${ip}`);
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const result = { blacklist: lines.map(l => l.split(':')[0].trim()).filter(Boolean).join('<br>') || 'N/A' };
        setCachedBlack(ip, result);
        return result;
    }

    // Обновление ячеек
    function updateGeo(ip, data, rows) {
        rows.forEach(row => {
            if (row.dataset.ip === ip) {
                const cTd = row.querySelector('td[data-geo="country"]');
                const cityTd = row.querySelector('td[data-geo="city"]');
                if (cTd) cTd.innerHTML = data.country;
                if (cityTd) cityTd.innerHTML = data.city;
            }
        });
    }

    function updateProvider(ip, prov, rows) {
        rows.forEach(row => {
            if (row.dataset.ip === ip) {
                const td = row.querySelector('td[data-geo="provider"]');
                if (td) td.innerHTML = prov;
            }
        });
    }

    function updateBlack(ip, data, rows) {
        rows.forEach(row => {
            if (row.dataset.ip === ip) {
                const cont = row.children[2]?.querySelector('.blacklist-container');
                if (cont) cont.innerHTML = data.blacklist;
            }
        });
    }

    function setBlackLoading(ip, rows) {
        rows.forEach(row => {
            if (row.dataset.ip === ip) {
                const cont = row.children[2]?.querySelector('.blacklist-container');
                if (cont) cont.innerHTML = 'Загрузка...';
            }
        });
    }

    let isProcessingTable = false;

    function initGeoLookup() {
        if (isProcessingTable) return false;
        const table = document.querySelector('table.table.table-striped.table-bordered:not(.bg-gray)');
        if (!table) return false;

        isProcessingTable = true;
        const rows = Array.from(table.querySelectorAll('tbody tr:not(.row-hits)'));
        const headerRow = table.querySelector('thead tr');
        const ipTh = headerRow.children[2];

        // Добавляем заголовки один раз
        if (!headerRow.querySelector('th[data-geo="country"]')) {
            const thCountry = document.createElement('th'); thCountry.textContent = 'Страна'; thCountry.dataset.geo = 'country';
            const thCity = document.createElement('th'); thCity.textContent = 'Город'; thCity.dataset.geo = 'city';
            const thProv = document.createElement('th'); thProv.textContent = 'Провайдер'; thProv.dataset.geo = 'provider';
            ipTh.after(thCountry); thCountry.after(thCity); thCity.after(thProv);
        }

        // Уникальные IP + автозагрузка только для первых 7 на странице 1
        const uniqueIPs = new Set();
        rows.forEach(r => {
            const ip = extractIP(r.children[2]?.textContent || '');
            if (ip && isValidIP(ip)) uniqueIPs.add(ip);
        });

        const pageEl = document.querySelector('.pagination .active a[data-page]');
        const currentPage = pageEl ? (parseInt(pageEl.dataset.page) || 0) + 1 : 1;
        const autoLoadIPs = currentPage === 1 ? Array.from(uniqueIPs).slice(0, 7) : [];

        rows.forEach(row => {
            const ipTd = row.children[2];
            const ip = extractIP(ipTd?.textContent || '');
            if (!ip || !isValidIP(ip)) return;

            row.dataset.ip = ip;

            // Клик по IP — копировать
            ipTd.style.cursor = 'pointer';
            ipTd.style.textDecoration = 'underline';
            ipTd.style.color = 'blue';
            ipTd.title = 'Клик — скопировать &dev-request-ip=' + ip;
            ipTd.onclick = () => navigator.clipboard.writeText(`&dev-request-ip=${ip}`).catch(() => {});

            // Создаём ячейки, если их нет
            ['country', 'city', 'provider'].forEach(type => {
                if (!row.querySelector(`td[data-geo="${type}"]`)) {
                    const td = document.createElement('td');
                    td.dataset.geo = type;
                    row.appendChild(td);
                }
            });

            const countryTd = row.querySelector('td[data-geo="country"]');
            const cityTd = row.querySelector('td[data-geo="city"]');
            const provTd = row.querySelector('td[data-geo="provider"]');

            // Geo (страна + город)
            const cachedGeo = getCachedGeo(ip);
            if (cachedGeo) {
                countryTd.innerHTML = cachedGeo.country;
                cityTd.innerHTML = cachedGeo.city;
            } else if (autoLoadIPs.includes(ip)) {
                countryTd.textContent = 'Загрузка...';
                cityTd.textContent = 'Загрузка...';
            } else {
                const btn = document.createElement('button');
                btn.textContent = 'Загрузить';
                btn.onclick = e => {
                    e.stopPropagation();
                    btn.disabled = true;
                    btn.textContent = 'Загрузка...';
                    fetchGeo(ip).then(d => updateGeo(ip, d, rows));
                };
                countryTd.appendChild(btn);
            }

            // Провайдер — всегда кнопка
            if (!provTd.innerHTML.trim()) {
                const btn = document.createElement('button');
                btn.textContent = 'Загрузить';
                btn.onclick = e => {
                    e.stopPropagation();
                    btn.disabled = true;
                    btn.textContent = 'Загрузка...';
                    fetchWhois(ip).then(p => { provTd.innerHTML = p; });
                };
                provTd.appendChild(btn);
            }

            // Blacklist — только кнопка, автозагрузки нет
            let container = ipTd.querySelector('.blacklist-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'blacklist-container';
                container.style.fontSize = '0.8em';
                container.style.color = '#666';
                container.style.marginTop = '2px';
                ipTd.appendChild(container);
            }

            const cachedBlack = getCachedBlack(ip);
            if (cachedBlack) {
                container.innerHTML = cachedBlack.blacklist;
            } else {
                const btn = document.createElement('button');
                btn.textContent = 'Загрузить';
                btn.style.fontSize = '0.8em';
                btn.onclick = e => {
                    e.stopPropagation();
                    btn.disabled = true;
                    btn.textContent = 'Загрузка...';
                    setBlackLoading(ip, rows);
                    fetchBlacklist(ip).then(data => {
                        updateBlack(ip, data, rows);
                        btn.remove(); // кнопка исчезает после загрузки
                    });
                };
                container.appendChild(btn);
            }
        });

        // Автозагрузка Geo для первых 7 IP
        if (autoLoadIPs.length > 0) {
            let i = 0;
            const next = () => {
                if (i >= autoLoadIPs.length) {
                    isProcessingTable = false;
                    return;
                }
                const ip = autoLoadIPs[i++];
                fetchGeo(ip)
                    .then(d => updateGeo(ip, d, rows))
                    .finally(next);
            };
            next();
        } else {
            isProcessingTable = false;
        }

        return true;
    }

    // MutationObserver
    const observer = new MutationObserver(mutations => {
        if (isProcessingTable) return;
        for (const m of mutations) {
            if (m.addedNodes.length) {
                for (const node of m.addedNodes) {
                    if (node.nodeType === 1 && (node.matches('table.table.table-striped.table-bordered:not(.bg-gray)') || node.querySelector('table.table.table-striped.table-bordered:not(.bg-gray)'))) {
                        initGeoLookup();
                        return;
                    }
                }
            }
        }
    });

    // Тумблер Вкл/Выкл
    function createToggle() {
        const label = document.createElement('label');
        label.style.cssText = 'position:fixed;right:10px;top:15%;z-index:10000;display:flex;align-items:center;gap:8px;cursor:pointer;background:#333;color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.width = '20px';
        checkbox.style.height = '20px';
        const span = document.createElement('span');
        span.textContent = 'Geo+Blacklist';

        label.append(checkbox, span);
        document.body.appendChild(label);

        const enabled = sessionStorage.getItem('geoEnhancerEnabled') !== 'false';
        checkbox.checked = enabled;

        if (enabled) {
            observer.observe(document.querySelector('#tabContentVisits') || document.body, { childList: true, subtree: true });
            initGeoLookup();
        }

        checkbox.addEventListener('change', () => {
            sessionStorage.setItem('geoEnhancerEnabled', checkbox.checked);
            if (checkbox.checked) {
                observer.observe(document.querySelector('#tabContentVisits') || document.body, { childList: true, subtree: true });
                initGeoLookup();
            } else {
                observer.disconnect();
                location.reload(); // проще всего — перезагрузить страницу
            }
        });
    }

    createToggle();
})();
